#! /usr/bin/env bash

# Install/update script for all my dot files
#
# Author Dimitar Dimitrov <mitkofr@yahoo.fr>
# ------------------------------------------

# shopt -s extglob

me=kurkale6ka
dotfiles="$HOME/test"
dest="$HOME/test"
bashfiles="$dotfiles/bashfiles"
help="$dotfiles/help"
vimfiles="$dotfiles/vimfiles"

# [[ ! -d $HOME/bin ]] && mkdir -p "$HOME/bin"
# ln -s "$bashfiles/scripts/iurl"   "$HOME/bin"
# ln -s "$bashfiles/scripts/utests" "$HOME/bin"
# ln -s "$bashfiles/scripts/dot"    "$HOME/bin"

getRepo() {

    if [[ $git ]] || command -v git >/dev/null 2>&1; then

        git=true

        #if git clone "git@207.97.227.248:$me/$1.git" "$dotfiles"; then
        if git clone "git@github.com:$me/$1.git" "$dotfiles"; then

            printf "Cloned $1 repository\n"
        else
            if wget -P "$dest" "http://github.com/$me/$1/tarball/master"; then

                tar -zxvf "$dest"/*"$me"*"$1"*.tar.gz -C "$dest"
                mv "$dest"/{*"$me"*"$1"*,"$1"}
            fi
        fi
    else
        if [[ ! $first ]]; then

            printf "Git is not installed on this machine\n"
            choice_git='I want to install git and retry later'
            choice_repos='I want to simply copy the repositories'

            select choice in "$choice_git" "$choice_repos"; do

                if [[ $choice == $choice_git ]]; then

                    abort=true
                    return 1
                fi
                break
            done

            (( first++ ))
        fi

        if [[ ! $abort ]] && wget -P "$dest" "http://github.com/$me/$1/tarball/master"; then

            tar -zxvf "$dest"/*"$me"*"$1"*.tar.gz -C "$dest"
            mv "$dest"/{*"$me"*"$1"*,"$1"}
        fi
    fi
}

link() {

    # Delete if not mine
    if [[ -e $2 && ! -O $2 ]]; then

        [[ -d $2 ]] && rm -r "$2" || rm "$2"
    fi

    # Delete if mine but not a link
    if [[ -e $2 && ! -L $2 ]]; then

        [[ -d $2 ]] && rm -r "$2" || rm "$2"
    fi

    # To be improved
    [[ ! -L $2 ]] && ln -s "$1/${2##*/}" "$3"
}

if [[ ! -d $bashfiles ]]; then

    if [[ ! $abort ]] && getRepo "${bashfiles##*/}"; then

        profile="$dest/.profile"
        bash_profile="$dest/.bash_profile"
        bashrc="$dest/.bashrc"
        bashrc_after="$dest/.bashrc_after"
        bash_logout="$dest/.bash_logout"
        inputrc="$dest/.inputrc"

        link "$bashfiles" "$profile" "$dest"
        link "$bashfiles" "$bash_profile" "$dest"
        link "$bashfiles" "$bashrc" "$dest"
        link "$bashfiles" "$bashrc_after" "$dest"
        link "$bashfiles" "$bash_logout" "$dest"
        link "$bashfiles" "$inputrc" "$dest"
    fi
fi

if [[ ! -d $help ]]; then

    if [[ ! $abort ]] && getRepo "${help##*/}"; then

        gitignore="$dest/.gitignore"
        screenrc="$dest/.screenrc"
        curlrc="$dest/.curlrc"

        link "$help" "$gitignore" "$dest"
        link "$help" "$screenrc" "$dest"
        link "$help" "$curlrc" "$dest"
    fi
fi

if [[ ! -d $vimfiles ]]; then

    if [[ ! $abort ]] && getRepo "${vimfiles##*/}"; then

        vim="$dest/.vim"
        vimrc="$dest/.vimrc"
        gvimrc="$dest/.gvimrc"

        link "$vimfiles" "$vim" "$dest"
        link "$vimfiles" "$vimrc" "$dest"
        link "$vimfiles" "$gvimrc" "$dest"

        ## All plugins: ln or cp if -win
        #for p in "$vimfiles/plugins"; do

        #done
    fi
fi

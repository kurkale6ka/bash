#! /usr/bin/env bash

# Install/update script for all my dot files
#
# Author Dimitar Dimitrov <mitkofr@yahoo.fr>
# ------------------------------------------

# Settings {{{1

#shopt -s extglob

# Plugin Authors
me=kurkale6ka
godlygeek=godlygeek
spiiph=spiiph
tpope=tpope

# matchit, vsearch, bgrep, php, xsd...
#git://github.com/godlygeek/netlib.git
#git://github.com/godlygeek/windowlayout.git

# todo:
# --repos, --dotfiles, --copy
# messages/quiet + warn
repos="$HOME"
dotfiles="$HOME"

bashfiles=bashfiles
helpfiles=help
vimfiles=vimfiles

bash_dotfiles=("$dotfiles/."{profile,bash_login,bash_profile})
bash_dotfiles+=("$dotfiles/."{bashrc,bashrc_after,bash_logout,logout,inputrc})
help_dotfiles=("$dotfiles/."{gitignore,screenrc,curlrc})
vim_dotfiles=("$dotfiles/."{vim,vimrc,gvimrc})

github='github.com'
arg_plugins=(ln -s)

# Print a message to stderr
warn() { echo "$@" >&2; }

show_help() { # {{{1

    local programme="${0##*/}"

    warn "Usage: $programme -l|--links"
    warn "       $programme --copy-plugins"
    warn "       $programme --move-plugins"
    warn "       $programme --repos=repos-folder"
    warn "       $programme --dotfiles=dotfiles-folder"
    warn "       $programme --ip=github's ip"
    warn "       $programme -h|--help|-?: this help text"
}

# Parse -|-- options {{{1
parse_option() {

    local option="$1"
    local value="${option#*=}"

    case "$option" in

        *repos*) repos="$value";;
        *dotfiles*) dotfiles="$value";;
        *ip*) github="$value";;
    esac
}

# Go trough all -|-- command line options
while [[ $1 == -* ]]; do

    case "$1" in

        -h|--help|-\?) show_help; exit 0;;
        --*=*) parse_option "$1"; shift;;
        -l|--links) arg_links="$1"; shift;;
        --copy-plugins) arg_plugins=(cp -f); shift;;
        --move-plugins) arg_plugins=(mv); shift;;
        --) shift; break;;
        -*) echo "invalid option: $1" 1>&2; show_help; exit 1;;
    esac
done

copyRepo() { # {{{1

    local author="$1"
    local repos="$2"
    local repo="$3"

    if wget -P "$repos" "http://github.com/$author/$repo/tarball/master"; then

        tar -zxvf "$repos"/*"$author"*"$repo"*.tar.gz -C "$repos"
        rm "$repos"/*"$author"*"$repo"*.tar.gz
        mv "$repos"/{*"$author"*"$repo"*/,"$repo"}
    fi
}

cloneRepo() { # {{{1

    local author="$1"
    local repo="$2"
    local destination="$3"
    local remote_host="git://$github/"

    [[ $author == $me ]] && remote_host="git@$github:"

    if [[ $git ]] || command -v git >/dev/null 2>&1; then

        git=true

        if git clone "$remote_host$author/$repo.git" "$destination"; then

            printf "Cloned $repo repository\n"
        else
            copyRepo "$author" "$repos" "$repo"
        fi
    else
        if [[ ! $first ]]; then

            printf "Git is not installed on this machine:\n\n"
            choice_git='I want to install git and retry later'
            choice_repos='I want to simply copy the repositories'

            select choice in "$choice_git" "$choice_repos"; do

            if [[ $choice == $choice_git ]]; then

                exit 0
            fi
            break
        done

        (( first++ ))
    fi

    copyRepo "$author" "$repos" "$repo"
fi
}

pullRepo() { # {{{1

    local author="$1"
    local repo="$2"
    local remote_host="git://$github/"

    [[ $author == $me ]] && remote_host="git@$github:"

    if [[ $git ]] || command -v git >/dev/null 2>&1; then

        git=true

        #if git pull "git@207.97.227.248:$author/$repo.git master"; then
        if git pull "$remote_host$author/$repo.git" master; then

            printf "Updated $repo repository\n"
        else
            if [[ ! $firstTime ]]; then

                printf "Git error, cannot update $repo:\n\n"
                choice_abort='Abort'
                choice_repos='I want to copy over the existing repositories'

                select choice in "$choice_abort" "$choice_repos"; do

                if [[ $choice == $choice_abort ]]; then

                    exit 0
                fi
                break
            done

            (( firstTime++ ))
        fi

        rm -rf "$repo"
        copyRepo "$author" "$repos" "$repo"
    fi
else
    if [[ ! $first ]]; then

        printf "Cannot update $repo: Git is not installed:\n\n"
        choice_git='I want to install git and retry later'
        choice_repos='I want to copy over the existing repositories'

        select choice in "$choice_git" "$choice_repos"; do

        if [[ $choice == $choice_git ]]; then

            exit 0
        fi
        break
    done

    (( first++ ))
fi

rm -rf "$repo"
copyRepo "$author" "$repos" "$repo"
    fi
}

linkToRepo() { # {{{1

    local repo="$1"
    local dotfiles="$2"
    local dotfile="$3"

    # Delete if not mine
    if [[ -e $dotfile && ! -O $dotfile ]]; then

        [[ -d $dotfile ]] && rm -r "$dotfile" || rm "$dotfile"
    fi

    # Delete if mine but not a link
    if [[ -e $dotfile && ! -L $dotfile ]]; then

        [[ -d $dotfile ]] && rm -r "$dotfile" || rm "$dotfile"
    fi

    # To be improved
    [[ ! -L $dotfile ]] && ln -s "$repo/${dotfile##*/}" "$dotfiles"
}

updateRepo() { # {{{1

    local author="$1"
    local repo="$2"
    local destination="$3"
    local dotfiles="$4"

    [[ -d $destination ]] && cd "$destination" && pullRepo "$author" "$repo"

    if [[ ! -d $destination ]] && cloneRepo "$author" "$repo" "$destination" ||
        [[ -d $destination && $arg_links ]]; then

        # If there are dotfiles to link to
        if [[ $5 ]]; then

            for dotfile in "${@:5}"; do

                linkToRepo "$destination" "$dotfiles" "$dotfile"
            done
        fi
    fi
}

# Actions {{{1

updateRepo "$me" "$bashfiles" "$repos/$bashfiles" "$dotfiles" "${bash_dotfiles[@]}"
updateRepo "$me" "$helpfiles" "$repos/$helpfiles" "$dotfiles" "${help_dotfiles[@]}"
updateRepo "$me" "$vimfiles"  "$repos/$vimfiles" "$dotfiles" "${vim_dotfiles[@]}"

updateRepo "$godlygeek" csapprox      "$repos/$vimfiles/plugins/csapprox"
updateRepo "$godlygeek" tabular       "$repos/$vimfiles/plugins/tabular"
updateRepo "$spiiph"    vim-space     "$repos/$vimfiles/plugins/vim-space"
updateRepo "$tpope"     vim-surround  "$repos/$vimfiles/plugins/vim-surround"
updateRepo "$tpope"     vim-repeat    "$repos/$vimfiles/plugins/vim-repeat"

# Create a symlink of this script in ~/bin
if [[ -d $repos/$bashfiles/scripts && ! -L $HOME/bin/${0##*/} ]]; then

    if [[ ! -d $HOME/bin ]]; then

        mkdir "$HOME/bin" && ln -s "$repos/$bashfiles/scripts/${0##*/}" "$HOME/bin"
    else
        ln -s "$repos/$bashfiles/scripts/${0##*/}" "$HOME/bin"
    fi
fi

if [[ -d $repos/$vimfiles/plugins ]]; then

    for plugin in "$repos/$vimfiles/plugins"/*; do

        while read -r -d $'\0'; do

            if [[ cp == ${arg_plugins[0]} ]]; then

                reply=${REPLY##*$plugin/}
                reply=${reply%/*}
                "${arg_plugins[@]}" -- "$REPLY" "$repos/$vimfiles/$reply"

            else
                "${arg_plugins[@]}" -- "$REPLY" "$repos/$vimfiles/${REPLY##*$plugin/}"
            fi

        done < <(find "$plugin" \( -name '*.vim' -o -name '*.txt' \) -print0)

    done
fi

# vim: se fdm=marker fmr&:
